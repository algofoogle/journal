# 25 Jul 2020

## ROM plug-in board

I made a ROM plug-in board that fits into the CPLD board, with the intent of proving that I can read an external memory and, in this case, display its contents on the VGA screen:

![ROM plug-in board in CPLD board](i/0047-rom-plugin.jpg)

It's designed to work with any DIP-28 JEDEC ROM, which includes the 27C64 (8kB), 27C128 (16kB), 27C256 (32kB) and equivalent mask ROMs like chips from NES NROM-128 and NROM-256 carts. Note that A14 is pulled high on the PCB, meaning that for 32kB ROMs it will only read the top 16kB.

In the picture above, I have a `HVC-SM-0 CHR` ROM chip plugged in, which is the Super Mario Bros. Character ROM. The pattern currently displayed on the monitor is a bit pattern from bytes read from the ROM. More on that later.

### Wiring

The wiring of the plug-in board is as follows:

![ROM wiring diagram](i/0047-rom-wiring.png)

Note that:
*   Pin 27 is pulled high (to VCCIO), which means that A14 is pulled high always from 32kB ROMs. For smaller ROMs, it is `/PGM` in a deactivated state.
*   Pin 1 is VPP for most DIP-28 ROMs, so we pull that low.
*   We can actually also use a 27C512 in this, because it too is a DIP-28. In that case, pin 1 is A15, which is pulled low here.
*   Adapting this to work with a DIP-24 (2708..2732) requires selecting the A13 line between the CPLD IO pin and the 5V supply.

## Commits to `t09a`

These are my recent commits to [`t09a`](https://github.com/algofoogle/sandpit/tree/master/fpga/XC9572XL/test09/t09a):

### [`288d0bd`](https://github.com/algofoogle/sandpit/commit/288d0bdc61e97abbe1d24a5ff2f07af84ba4df0f#diff-781ac0af63b12d0aaad826f58c10d831)

VGA scanner runs at 50MHz; each clock cycle is "half" a pixel, so [16 clocks counted by `h`](https://github.com/algofoogle/sandpit/blob/288d0bdc61e97abbe1d24a5ff2f07af84ba4df0f/fpga/XC9572XL/test09/t09a/t09a.v#L57-L58) is 8 horizontal pixels, read as one byte from the ROM.

Left button shows the state of the lower 8 bits of the ROM address in all lines of the screen.

Right button shows a test pattern in all rows of the screen.

With no buttons pressed, it show the first 80 bytes of the ROM, in all rows of the screen.

![Bars from first 80 bytes of the ROM](i/0047-rom-bars.jpg)


### [`f3afddd`](https://github.com/algofoogle/sandpit/commit/f3afddd90cd9665301fc8b262485466529dba075#diff-781ac0af63b12d0aaad826f58c10d831)

Now it only show 512 pixels (i.e. 64 bytes) per line, allowing us now to fit a 512x256 bitmap image in 16kB of ROM.

Holding both buttons now fills the screen completely, which is to help get the monitor to auto-adjust.

Note: There was also a commit before this one ([`e19a0ad`](https://github.com/algofoogle/sandpit/commit/e19a0ad09c022092e5bb571420edcd04f245340c#diff-781ac0af63b12d0aaad826f58c10d831)) which was just to adjust the timing of the ROM read sequence.

### [`907317c`](https://github.com/algofoogle/sandpit/commit/907317c853300f5e57b7f8895f7c22b3ed5f9a9c#diff-781ac0af63b12d0aaad826f58c10d831)

I added [`pbm2rom.rb`](https://github.com/algofoogle/sandpit/blob/master/fpga/XC9572XL/test09/t09a/data/pbm2rom.rb). Photoshop can save a bitmap image file as a `.pbm` which is basically raw binary image data. It's easy to convert to a ROM image that can be displayed using this system I've been making.

`pbm2rom` expects 1 command-line argument: The PBM file to convert. It will spit out the same filename with `.bin` appended. For now it works only on "`P4`"-format files that are 512x256 pixels, but could be adapted for other dimensions. The resulting file is 16kB exactly (64 bytes per line, 256 lines).

## Burning a ROM

A suitable EEPROM I have for use in this project is the [W27E257-12](http://pdf.datasheetcatalog.com/datasheet/WinbondElectronics/mXyzrstw.pdf) (32k &times; 8, 120nS access time).

I expect I will ble able to use my TOP853 programmer. It's a piece of junk, but it has worked OK in the past. The only trick is that I've only been able to get the software to work in Windows XP before.

For that I'm using a Windows XP VM. I've got one obtained from Microsoft for testing IE, but it has an expiry date. My "Windows XP Mode" VM has a snapshot called "Topwin works" taken 2019-04-04 at 23:11. I've restored to that snapshot, and [this method](https://superuser.com/a/539881) should allow me to run it with a clock in the past so that it won't expire.

First, I'll try booting from a fresh snapshot of the VM, called "Snapshot 3".


## Other improvement ideas for the CPLD PCB

*   Maybe use 10-pin 0.1&Prime; headers, with one space between each row, so they're easier to solder adjacent each other, but still breadboard compatible?
*   Maybe make headers DIL instead of SIL, so we get *pairs* of sockets, making it easier to do double-up wiring.
*   More DIP rows in the "riser" board; current version is not wide enough to fit DIP-600. I had to "wedge" my chip socket into this board at a bad angle.
*   Thicker traces on the riser, at least near the edge headers, optionally with exposed pads, so it's possible to solder to them after cutting the trace.
*   Optional resistor arrays: Pull up, down, or just in-series.
*   Holes or notches to help with inserting/removing from breadboard. Holes could be used with a hook tool, or could even have "posts" permanently screwed in that are easier to grab.
*   Move JTAG headers so they don't occlude the riser being used as a daughterboard.
*   Better/dual placement of LEDs and buttons.
*   Some cool plug-in boards.
*   "Edge"-mount connection: card-edge style, but also with the option to just solder a socket or DIL header pins on directly instead.
