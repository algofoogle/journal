# 5 Dec 2019

## TrinketKeyboard

I zipped [TrinketKeyboard](https://github.com/adafruit/Adafruit-Trinket-USB/tree/master/TrinketKeyboard) and added it to Arduino IDE (see [yesterday](0004-2019-12-04.md) for how to add ZIP libraries).

A blank sketch with `#include <TrinketKeyboard.h>` uses this much of the Digispark:

```
Sketch uses 2952 bytes (49%) of program storage space. Maximum is 6012 bytes.
Global variables use 92 bytes of dynamic memory.
```

I was able to get TrinketKeyboard to work, but I was getting some unexpected results:

1.  `TrinketKeyboard.isConnected()` issue:
    *   After `TrinketKeyboard.begin();` you can [supposedly](https://github.com/adafruit/Adafruit-Trinket-USB/blob/51f208bc569dd79d7357f16d548ed0c43f4927e8/TrinketKeyboard/examples/TrinketKeyboardPrank/TrinketKeyboardPrank.ino#L12) do `while (TrinketKeyboard.isConnected() == 0);` to await verification that the keyboard is connected, but I was finding it was *always* returning 0 and hence getting stuck on this line. Even after we were successfully sending keyboard keystrokes, it was still returning 0.
    *   Someone else noticed this and [supposedly worked around it](https://github.com/adafruit/Adafruit-Trinket-USB/issues/18#issuecomment-268548349) by switching to `TrinketHidCombo` and including a `.poll()` in each iteration of the wait loop, but trying this with `TrinketKeyboard` instead of `TrinketHidCombo` didn't work for me.
    *   Later I will try `TrinketHidCombo` instead, but I've seen some people say that they can't get it to get/set keyboard LEDs. I will report back on that later.
    *   Maybe this is specifically a DigiSpark issue?
2.  Initial keyboard writes, after `TrinketKeyboard.begin()`, seem to be lost. Adding a big delay (say, about 2 seconds) seems to avoid this. Supposedly this is why waiting for `isConnected()` would otherwise be a good idea.
3.  On my Mac, programming the DigiSpark with TrinketKeyboard code doesn't always lead to a successful initial start-up. I (almost?) always have to unplug and replug the DigiSpark before it will work, and even then it often doesn't work on the first try. This might be more to do with the Mac, or the DigiSpark in general (since similar issues existed with the `DigiKeyboard` library, I think).

I wrote [01-trinket1] to try and work out what's going on. Note that it records times at `step1` and `step2`. Its output was surprising...

First try that worked:

```
#1AThis is a test. Time=0..0 start=0 isConnected=0
#2AThis is a test. Time=4991..4991 start=0 isConnected=0
#3AThis is a test. Time=8219..8219 start=0 isConnected=0
#4AThis is a test. Time=11445..11445 start=0 isConnected=0
#5AThis is a test. Time=14707..14707 start=0 isConnected=0
#6AThis is a test. Time=17969..17969 start=0 isConnected=0
#7AThis is a test. Time=21229..21229 start=0 isConnected=0
#8AThis is a test. Time=24489..24489 start=0 isConnected=0
#9AThis is a test. Time=27748..27748 start=0 isConnected=0
```

Second try that worked:

```
#1AThis is a test. Time=0..0 start=0 isConnected=0
#2AThis is a test. Time=15339..15339 start=0 isConnected=0
#3AThis is a test. Time=18599..18599 start=0 isConnected=0
#4AThis is a test. Time=21860..21860 start=0 isConnected=0
```

On the first try, the 2nd iteration started nearly 5 seconds after the first. There is only a built-in 2.3-second delay, and a certain amount of time can be pinned on how long it actually takes the write to output all characters. Maybe that's acceptable, but then the second try, the first iteration took over 15 seconds to complete! The initial `.poll()` must've been fine, given that either size of it is 0ms, but then maybe it got hung up on the first actual keystrokes (since I watched it march out each of the characters of line 1, and they happened at normal speed).

On a couple of subsequent occasions, I've had similar results: 12 seconds, for instance.

I wonder if the problem is a faulty DigiSpark?

## Other notes

*   `digitalWrite(1, HIGH)` for an `OUTPUT` pin means turning on its internal pull-up resistors, [apparently](https://github.com/adafruit/Adafruit-Trinket-USB/blob/51f208bc569dd79d7357f16d548ed0c43f4927e8/TrinketKeyboard/examples/TrinketKeyboardExample/TrinketKeyboardExample.ino#L17).
*   See: https://github.com/adafruit/Adafruit-Trinket-USB/issues/20 and https://digistump.com/board/index.php?topic=1530.0 and https://digistump.com/board/index.php?topic=2757.0


[01-trinket1]: code/0005-trinket-usb/01-trinket1
