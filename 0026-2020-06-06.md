# 6 Jun 2020

I'm going to test out my Dangerous Prototypes XC9572XL board before I try assembling my own board.

*   I'm installing the 15GB Xilinx ISE Webpack 14.7 VM version on Windows 10 (Home?) 64-bit. It normally installs its own copy of VirtualBox but instead it detects the VirtualBox I already have and offers to just add to that (with a warning about being untested on my version).
*   It takes a long time at the "Import ISE Virtual Appliance" step. It's an `ova` file.
*   I've dug out my DP XC9572XL board and Bus Blaster v2.0a1.
*   I downloaded [`CPLD.Breakout.Package.v1.0.zip`](https://github.com/DangerousPrototypes/Downloads/blob/master/CPLD.Breakout.Package.v1.0.zip). It's a ZIP of [this GitHub tree](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package). I don't know whether I'll actually need it, but it includes:
    *   [`Device_examples`](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package/Device_examples): Various examples in here that are referenced [here](http://dangerousprototypes.com/docs/CPLD:_Complex_programmable_logic_devices#Example_devices). That same page also references the "[Logic analyzer example in 72 macrocells](http://dangerousprototypes.com/docs/Lulu:_Yet_another_logic_analyzer)" that is included in the tree as [`Verilog-LogicAnalyzer/trigger.v`](https://github.com/DangerousPrototypes/CPLD_Breakout/blob/master/package/Device_examples/Verilog-LogicAnalyzer/trigger.v) (in Verilog). NOTE: `Device_examples` includes both `.sch` files (EAGLE Schematic files; I think used *only* to make the screenshots in the DP Wiki) and `.xise` files (Xilinx ISE project files?) that must be the actual "schematic capture" logic implementations.
    *   [`PCBs_production`](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package/PCBs_production): Schematics and PCB layouts, etc, for XC2C and XC9572XL boards. EAGLE format.
    *   [`Programmer_BusPiratev3`](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package/Programmer_BusPiratev3): Firmware/tools for using Bus Pirate to "play" XSVF binary via JTAG to program the CPLD? Includes [`xc95prog.xsvf`](https://github.com/DangerousPrototypes/CPLD_Breakout/blob/master/package/Programmer_BusPiratev3/xc95prog.xsvf) which is probably the default XC95 firmware with the inverse LED toggle demo.
    *   [`Tutorials`](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package/Tutorials): Includes the [code for XC95 Tutorials](https://github.com/DangerousPrototypes/CPLD_Breakout/tree/master/package/Tutorials/xc9572xl) that are probably what is described [here](http://dangerousprototypes.com/docs/CPLD:_Complex_programmable_logic_devices#CPLD_development_tutorials).


## Initial test of the DP XC9572XL breakout board

### Bus Pirate first

*   Get to know my Bus Pirate v3.5 again: I'll use it as my power supply.
*   Plug in Bus Pirate via USB. `PWR` led comes on. Windows recognises it as `COM13` for me. Windows offers "Advanced" settings for the device, allowing the COM port number to be changed, if needed.
*   Configure PuTTY to use `Serial` mode to `COM13` at 115200 bps. PuTTY has advanced settings in `Connection > Serial`: Ensure 8/N/1 and `Flow control` should be set to `None`.
*   Start the connection and hit <kbd>ENTER</kbd>, and hopefully the `HiZ>` prompt will appear. `?` command can be used to see available options.
*   `i` command shows version info:
    ```
    HiZ>i
    Bus Pirate v3.5
    Firmware v6.1 r1676  Bootloader v4.4
    DEVID:0x0447 REVID:0x3043 (24FJ64GA002 B5)
    http://dangerousprototypes.com
    ```
*   Not sure what version is [documented here](http://dangerousprototypes.com/docs/Bus_Pirate_101_tutorial#Get_to_know_the_terminal_interface) but my version **lacks** [some bus modes](http://dangerousprototypes.com/docs/Bus_Pirate_101_tutorial#Bus_modes.2C_protocol_libraries) inc. JTAG. This is what I get from the `m` command:
    ```
    HiZ>m
    1. HiZ
    2. 1-WIRE
    3. UART
    4. I2C
    5. SPI
    6. 2WIRE
    7. 3WIRE
    8. LCD
    x. exit(without change)
    ```
*   Either my version is old, or my version is newer (and the extra modes were removed for other reasons). There's some info [here](http://dangerousprototypes.com/docs/Bus_Pirate#Download) (under "[Old legacy stuff](http://dangerousprototypes.com/docs/Bus_Pirate#:~:text=Old%20legacy%20stuff)") that talks about my firmware v6.1 being official, but old. That page also explains that the [BusPirate/Bus_Pirate repo on GitHub](https://github.com/BusPirate/Bus_Pirate) is where you can get the best new firmware, with [discussion here](http://dangerousprototypes.com/forum/index.php?topic=8498.0#p65290) about its release. More info about v6.1 and JTAG [here](http://dangerousprototypes.com/docs/Bus_Pirate#JTAG) and it effectively explains this old version of the firmware does *not* include terminal-mode JTAG but it *can* be used in a binary mode via OpenOCD (at least I *think* that's what it means).
*   Check pin states with `v` command:
    ```
    Pinstates:
    1.(BR)  2.(RD)  3.(OR)  4.(YW)  5.(GN)  6.(BL)  7.(PU)  8.(GR)  9.(WT)  0.(Blk)
    GND     3.3V    5.0V    ADC     VPU     AUX     CLK     MOSI    CS      MISO
    P       P       P       I       I       I       I       I       I       I
    GND     0.00V   0.00V   0.00V   0.00V   L       L       L       L       L
    ```
    I think this can be read as follows, after the `Pinstates:` line:
    1.  1st line identifies pin number and colour when using the supplied probes (hooks on IDC ribbon).
    2.  Pin name.
    3.  Pin function (`P` = Power; `I` = Input?)
    4.  Current level. `0.00V` indicates that power supplies are off.
*   There is a `W` command to turn PSUs on, and `w` to turn them off, but these commands don't work in `HiZ` mode.
*   Per [this](http://dangerousprototypes.com/docs/Bus_Pirate_102_tutorial#Power_supplies), PSUs can only be enabled if not in `HiZ` mode, and PSUs (3.3V, and 5V) can supply 150mA each.
*   I tested with my DMM: in the initial `HiZ` mode, the `+5V` pin is not powered.
*   By doing `m2` or `m8` we can go to a mode that requires no other choices to be made, and the `MODE` LED will turn on.
*   Doing `W` now should turn on the `VREG` LED, show about 5V on the DMM, and `v` should show about 3.3V on pin 2 and about 5V on pin 3:
    ```
    LCD>v
    Pinstates:
    1.(BR)  2.(RD)  3.(OR)  4.(YW)  5.(GN)  6.(BL)  7.(PU)  8.(GR)  9.(WT)  0.(Blk)
    GND     3.3V    5.0V    ADC     VPU     AUX     SCL     SDA     -       -
    P       P       P       I       I       I       O       O       O       I
    GND     3.29V   5.16V   0.00V   0.00V   L       L       L       L       L
    ```
*   Go back to `m1` to turn off PSU and return to safe HiZ state.
*   Attach proper hooks/probes loom to BP, attach GND and 5V hooks to DMM, and test with `m2` followed by `W` to make sure the hooks have their PSU lines working properly.
*   Turn off PSUs with `w`, then attach GND and 5V hooks to `GND`

### Hooking up the BP to the XC95 board

1.  Make sure BP is in HiZ mode with `m1`.
2.  Plug in BP hooks/probes, and attach to XC95 board: GND hook to `GND` on XC95, and 5V hook to `V+` on XC95.
3.  Attach DMM to XC95's JTAG header: `GND` and `VTG`. This will be for testing the XC95's 3.3V supply.
4.  Put a jumper across the XC95's `3V3 / IO` header pins. This selects the main 3.3V supply as the `VCCIO` voltage.
5.  Go to mode `m2` and do `W` command.
6.  DMM should show about 3.3V, and XC95 board should have `PWR` LED lit, at minimum.
7.  With default firmware, XC95's `D1` should be lit.
8.  Press the pushbutton on the XC95, and while pressed, `D2` should be lit and `D1` will turn off.
9.  This verifies that the default firmware is working.
10. Go to mode `m1` again to turn everything off.
11. **VERY IMPORTANT FOR NEXT TEST:** Disconnect 5V hook.
12. Attach 3.3V hook to the XC95's `3V3`.
13. Go back to mode `m2` and do `W` again.
14. Test in points 6..9 should work again. NOTE: I've observed that the DMM shows `VTG` to be a little flat: A hair under 3.2V. This is probably the BP supply's fault.
15. Go to mode `m1` again to turn everything off.
16. Move the 3.3V hook's connection to the XC95's `VTG` pin. Probably need to disconnect the DMM.
17. Go back to mode `m2` and do `W` again.
18. Test in points 6..9 should work again: This should show that the JTAG `VTG` pin is in fact wired up to the same net as the `3V3` pin.
19. Go to mode `m1` again to turn everything off.
20. It *should also be possible* to power `V+` using the 5V hook and take the `VIO` jumper off and instead power the `IO` pin using the 3.3V hook... but I'm not going to take a risk there and muck around with that if I don't need to :)

**IMPORTANT:** Don't ever power the XC95's `V+` and `3V3` (or `VTG`) lines at the same time. That would mean two different power supplies, and possibly contention, and might lead to damage.



## "Burning" the XC9572XL

*   [This ("JTAG cables")](http://dangerousprototypes.com/docs/Xilinx_XC9500XL_CPLD_quick_start#JTAG_cables) says to use "Parallel cable and ISE" or "FT2232 JTAG". Not sure whether either of these means USB Blaster or DP Bus Blaster.
*   [This ("Loaders")](http://dangerousprototypes.com/docs/Xilinx_XC9500XL_CPLD_quick_start#Loaders) says that (X)SVF files contain the CPLD configuration and it can be "played" via JTAG cable, with suggestions to use either:
    *   [UrJTAG](http://urjtag.sourceforge.net/) - load SVF with a number of programmers, including common FT2232 programmers
    *   [OpenOCD](http://www.openocd.org/) - detects FPGA/CPLDs, but doesn't do much with them.

...TBC...

## Notes

These notes are half-baked:

*   Try out JTAG: Can we talk to the chip?
*   Use BP to get to know how to control various modules, inc. via various serial protocols, and then make sure we can make the XC95 do the same: A good test to verify that the devices work before trying to prove we can do Verilog properly. Will help weed out programming mistakes, hardware faults, and general mishaps.
BP will come in handy later when trying to do tests of my CPLD code/circuits.
*   [This](http://dangerousprototypes.com/docs/XC9572XL_CPLD_dev-board_introduction#Overview) says "[5volts max](http://dangerousprototypes.com/docs/XC9572XL_CPLD_dev-board_introduction#:~:text=5volts%20max)" for `V+`. I'm sure it would take more, but don't push it. It's pretty tiny!

## Improvements for my next XC9572XL board

*   Check the footprints of all components I actually intend to solder on.
*   My screw holes are tiny. Diameter needs to be at least doubled to fit a standard PC screw (which fit my stand-offs), and head clearance needs to be WAY more.
*   Better form factor to suit other devices it might plug into?
*   Thinner PCB?
*   Smaller boards, or put more on them?
*   Footprints for different XC9500 chips. This could be tricky: XC9572XL's 64-pin pitch is 0.5mm, while 44-pin (?) version has a larger pitch.
*   JTAG pins on the edge: Make into a nice 90&deg; header?
*   Larger pad for LDO.
*   Beware thermal relief design: Pads need straight leads out to avoid tombstoning.
*   Better capacitor placement.

